<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Fixed - Particle Life</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            font-family: monospace;
        }
        canvas {
            border: 2px solid #0f0;
            background: #000;
            display: block;
            margin: 20px auto;
        }
        #status {
            text-align: center;
            padding: 10px;
            background: #333;
            border-radius: 5px;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            margin: 0 10px;
            padding: 5px 15px;
            background: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0a0;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Particle Life - Fixed Version</h1>
    <div id="status">Initializing...</div>

    <canvas id="canvas" width="800" height="600"></canvas>

    <div class="controls">
        <button id="reset">Reset</button>
        <button id="chaos">Apply Chaos Preset</button>
        <button id="symbiosis">Apply Symbiosis Preset</button>
    </div>

    <div id="info" style="text-align: center; margin-top: 20px;"></div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        const infoDiv = document.getElementById('info');

        let ws = null;
        let frameCount = 0;
        let particles = [];
        let config = null;

        const colors = ['#ff5a5f', '#00a699', '#f7b733', '#3c91e6', '#9b59b6'];

        function log(message) {
            console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
        }

        function setStatus(text, isError = false) {
            statusDiv.textContent = text;
            statusDiv.style.color = isError ? '#f00' : '#0f0';
            log(text);
        }

        function connect() {
            setStatus('Connecting to WebSocket...');

            ws = new WebSocket(`ws://${window.location.host}/ws`);

            ws.onopen = () => {
                setStatus('Connected!');
                frameCount = 0;
            };

            ws.onclose = (event) => {
                setStatus(`Disconnected (code: ${event.code}). Reconnecting in 2s...`, true);
                setTimeout(connect, 2000);
            };

            ws.onerror = (error) => {
                setStatus('WebSocket error', true);
                console.error('WebSocket error:', error);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);

                    if (message.type === 'state') {
                        frameCount++;
                        const payload = message.payload;
                        particles = payload.particles || [];
                        config = payload.config;

                        // Update info
                        infoDiv.innerHTML = `
                            Frame: ${frameCount} |
                            Particles: ${particles.length} |
                            Species: ${config ? config.species_count : 0}
                        `;

                        // Render particles
                        render();

                        if (frameCount === 1) {
                            setStatus(`Rendering ${particles.length} particles`);
                        }
                    } else if (message.type === 'error') {
                        setStatus(`Server error: ${message.detail}`, true);
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
        }

        function render() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw particles with larger radius
            const radius = 4;
            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];
                ctx.fillStyle = colors[p.species % colors.length];
                ctx.beginPath();
                ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            } else {
                setStatus('Not connected', true);
            }
        }

        // Setup controls
        document.getElementById('reset').onclick = () => {
            sendMessage({ type: 'reset' });
            setStatus('Reset sent');
        };

        document.getElementById('chaos').onclick = () => {
            sendMessage({ type: 'use_preset', name: 'chaos' });
            setStatus('Applying chaos preset...');
        };

        document.getElementById('symbiosis').onclick = () => {
            sendMessage({ type: 'use_preset', name: 'symbiosis' });
            setStatus('Applying symbiosis preset...');
        };

        // Start connection
        connect();

        // Initial render
        render();
    </script>
</body>
</html>